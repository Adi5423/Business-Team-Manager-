{% extends 'base.html' %}
{% block title %}Team Overview{% endblock %}
{% block content %}
  <div class="max-w-xl mx-auto w-full">
    <h1 class="text-2xl font-bold mb-6 text-center">Team Overview</h1>

    <!-- Tabs -->
    <div class="mb-6 overflow-x-auto">
      <ul class="flex border-b min-w-max whitespace-nowrap glass">
        <li class="-mb-px mr-1">
          <a href="#all" class="bg-white inline-block border-l border-t border-r rounded-t py-2 px-4 font-semibold" onclick="showTab('all')">All</a>
        </li>
        <li class="-mb-px mr-1">
          <a href="#employee" class="bg-white inline-block border-l border-t border-r rounded-t py-2 px-4 font-semibold" onclick="showTab('employee')">Employees</a>
        </li>
        <li class="-mb-px mr-1">
          <a href="#manager" class="bg-white inline-block border-l border-t border-r rounded-t py-2 px-4 font-semibold" onclick="showTab('manager')">Managers</a>
        </li>
        <li class="-mb-px mr-1">
          <a href="#head" class="bg-white inline-block border-l border-t border-r rounded-t py-2 px-4 font-semibold" onclick="showTab('head')">Heads</a>
        </li>
      </ul>
    </div>

    <!-- Tab Contents -->
    <div id="tab-all">
      <h2 class="text-xl font-bold mt-6">All People</h2>
      <ul class="space-y-4">
        {% for profile in profiles %}
          <li class="glass bg-white/40 rounded shadow p-4 flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
            <div class="flex flex-col sm:flex-row sm:items-center space-y-1 sm:space-y-0 sm:space-x-4 w-full">
              <span class="font-semibold text-lg">{{ profile.user.username }}</span>
              <span class="text-gray-500">- {{ profile.role }}</span>
            </div>
            <div class="flex justify-center items-center w-full sm:w-auto mt-2 sm:mt-0">
              <div class="relative w-16 h-16">
                <svg class="w-16 h-16" viewBox="0 0 36 36">
                  <circle class="text-gray-200" stroke-width="4" stroke="currentColor" fill="none" cx="18" cy="18" r="16" />
                  <circle class="text-blue-500" stroke-width="4" stroke-linecap="round" stroke="currentColor" fill="none" cx="18" cy="18" r="16"
                    stroke-dasharray="100, 100" stroke-dashoffset="{{ profile.progress_offset }}" style="transition: stroke-dashoffset 0.5s;" />
                </svg>
                <span class="absolute inset-0 flex items-center justify-center text-lg font-bold text-blue-700">{{ profile.progress|default:0 }}%</span>
              </div>
            </div>
            <div class="flex flex-col sm:flex-row mt-2 sm:mt-0 space-y-2 sm:space-y-0 sm:space-x-2 w-full sm:w-auto justify-center">
              {% if user.is_authenticated %}
                {% if profile.user != user %}
                  {% if user.employeeprofile.role == 'head' or user.employeeprofile.role == 'manager' or user.employeeprofile.role == 'admin' %}
                    <a href="{% url 'edit-profile' profile.user.id %}" class="text-blue-600 underline">Edit</a>
                    <a href="{% url 'assign-task' %}?to={{ profile.id }}" class="text-green-600 underline">Assign Task</a>
                  {% endif %}
                {% endif %}
              {% endif %}
              {% if profile.user == user %}
                <a href="{% url 'my-profile' %}" class="text-blue-600 underline ml-0 sm:ml-4">View My Profile</a>
              {% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>
    </div>

    <div id="tab-employee" style="display:none;">
      <h2 class="text-xl font-bold mt-6">Employees</h2>
      <ul class="space-y-4">
        {% for profile in profiles %}
          {% if profile.role == 'employee' %}
            <li class="glass bg-white/40 rounded shadow p-4 flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
              <div class="flex flex-col sm:flex-row sm:items-center space-y-1 sm:space-y-0 sm:space-x-4 w-full">
                <span class="font-semibold text-lg">{{ profile.user.username }}</span>
                <span class="text-gray-500">- {{ profile.role }}</span>
              </div>
              <div class="flex justify-center items-center w-full sm:w-auto mt-2 sm:mt-0">
                <div class="relative w-16 h-16">
                  <svg class="w-16 h-16" viewBox="0 0 36 36">
                    <circle class="text-gray-200" stroke-width="4" stroke="currentColor" fill="none" cx="18" cy="18" r="16" />
                    <circle class="text-blue-500" stroke-width="4" stroke-linecap="round" stroke="currentColor" fill="none" cx="18" cy="18" r="16"
                      stroke-dasharray="100, 100" stroke-dashoffset="{{ profile.progress_offset }}" style="transition: stroke-dashoffset 0.5s;" />
                  </svg>
                  <span class="absolute inset-0 flex items-center justify-center text-lg font-bold text-blue-700">{{ profile.progress|default:0 }}%</span>
                </div>
              </div>
              <div class="flex flex-col sm:flex-row mt-2 sm:mt-0 space-y-2 sm:space-y-0 sm:space-x-2 w-full sm:w-auto justify-center">
                {% if user.is_authenticated %}
                  {% if profile.user != user %}
                    {% if user.employeeprofile.role == 'head' or user.employeeprofile.role == 'manager' or user.employeeprofile.role == 'admin' %}
                      <a href="{% url 'edit-profile' profile.user.id %}" class="text-blue-600 underline">Edit</a>
                      <a href="{% url 'assign-task' %}?to={{ profile.id }}" class="text-green-600 underline">Assign Task</a>
                    {% endif %}
                  {% endif %}
                {% endif %}
                {% if profile.user == user %}
                  <a href="{% url 'my-profile' %}" class="text-blue-600 underline ml-0 sm:ml-4">View My Profile</a>
                  <a href="{% url 'report-task' 0 %}" class="text-orange-600 underline ml-0 sm:ml-4">Report/Mark Task</a>
                {% endif %}
              </div>
            </li>
          {% endif %}
        {% endfor %}
      </ul>
    </div>

    <div id="tab-manager" style="display:none;">
      <h2 class="text-xl font-bold mt-6">Managers</h2>
      <ul class="space-y-4">
        {% for profile in profiles %}
          {% if profile.role == 'manager' %}
            <li class="glass bg-white/40 rounded shadow p-4 flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
              <div class="flex flex-col sm:flex-row sm:items-center space-y-1 sm:space-y-0 sm:space-x-4 w-full">
                <span class="font-semibold text-lg">{{ profile.user.username }}</span>
                <span class="text-gray-500">- {{ profile.role }}</span>
              </div>
              <div class="flex justify-center items-center w-full sm:w-auto mt-2 sm:mt-0">
                <div class="relative w-16 h-16">
                  <svg class="w-16 h-16" viewBox="0 0 36 36">
                    <circle class="text-gray-200" stroke-width="4" stroke="currentColor" fill="none" cx="18" cy="18" r="16" />
                    <circle class="text-blue-500" stroke-width="4" stroke-linecap="round" stroke="currentColor" fill="none" cx="18" cy="18" r="16"
                      stroke-dasharray="100, 100" stroke-dashoffset="{{ profile.progress_offset }}" style="transition: stroke-dashoffset 0.5s;" />
                  </svg>
                  <span class="absolute inset-0 flex items-center justify-center text-lg font-bold text-blue-700">{{ profile.progress|default:0 }}%</span>
                </div>
              </div>
              <div class="flex flex-col sm:flex-row mt-2 sm:mt-0 space-y-2 sm:space-y-0 sm:space-x-2 w-full sm:w-auto justify-center">
                {% if user.is_authenticated %}
                  {% if profile.user != user %}
                    {% if user.employeeprofile.role == 'head' or user.employeeprofile.role == 'manager' or user.employeeprofile.role == 'admin' %}
                      <a href="{% url 'edit-profile' profile.user.id %}" class="text-blue-600 underline">Edit</a>
                      <a href="{% url 'assign-task' %}?to={{ profile.id }}" class="text-green-600 underline">Assign Task</a>
                    {% endif %}
                  {% endif %}
                {% endif %}
                {% if profile.user == user %}
                  <a href="{% url 'my-profile' %}" class="text-blue-600 underline ml-0 sm:ml-4">View My Profile</a>
                {% endif %}
              </div>
            </li>
          {% endif %}
        {% endfor %}
      </ul>
    </div>

    <div id="tab-head" style="display:none;">
      <h2 class="text-xl font-bold mt-6">Heads</h2>
      <ul class="space-y-4">
        {% for profile in profiles %}
          {% if profile.role == 'head' %}
            <li class="glass bg-white/40 rounded shadow p-4 flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0">
              <div class="flex flex-col sm:flex-row sm:items-center space-y-1 sm:space-y-0 sm:space-x-4 w-full">
                <span class="font-semibold text-lg">{{ profile.user.username }}</span>
                <span class="text-gray-500">- {{ profile.role }}</span>
              </div>
              <div class="flex justify-center items-center w-full sm:w-auto mt-2 sm:mt-0">
                <div class="relative w-16 h-16">
                  <svg class="w-16 h-16" viewBox="0 0 36 36">
                    <circle class="text-gray-200" stroke-width="4" stroke="currentColor" fill="none" cx="18" cy="18" r="16" />
                    <circle class="text-blue-500" stroke-width="4" stroke-linecap="round" stroke="currentColor" fill="none" cx="18" cy="18" r="16"
                      stroke-dasharray="100, 100" stroke-dashoffset="{{ profile.progress_offset }}" style="transition: stroke-dashoffset 0.5s;" />
                  </svg>
                  <span class="absolute inset-0 flex items-center justify-center text-lg font-bold text-blue-700">{{ profile.progress|default:0 }}%</span>
                </div>
              </div>
              <div class="flex flex-col sm:flex-row mt-2 sm:mt-0 space-y-2 sm:space-y-0 sm:space-x-2 w-full sm:w-auto justify-center">
                {% if user.is_authenticated %}
                  {% if profile.user != user %}
                    {% if user.employeeprofile.role == 'head' or user.employeeprofile.role == 'admin' %}
                      <a href="{% url 'edit-profile' profile.user.id %}" class="text-blue-600 underline">Edit</a>
                      <a href="{% url 'assign-task' %}?to={{ profile.id }}" class="text-green-600 underline">Assign Task</a>
                    {% endif %}
                  {% endif %}
                {% endif %}
                {% if profile.user == user %}
                  <a href="{% url 'my-profile' %}" class="text-blue-600 underline ml-0 sm:ml-4">View My Profile</a>
                {% endif %}
              </div>
            </li>
          {% endif %}
        {% endfor %}
      </ul>
    </div>
  </div>
  <script>
    function showTab(tab) {
      document.getElementById('tab-all').style.display = 'none';
      document.getElementById('tab-employee').style.display = 'none';
      document.getElementById('tab-manager').style.display = 'none';
      document.getElementById('tab-head').style.display = 'none';
      document.getElementById('tab-' + tab).style.display = 'block';
      localStorage.setItem('lastTab', tab);
    }
    // Show last selected tab or 'All' by default
    const lastTab = localStorage.getItem('lastTab') || 'all';
    showTab(lastTab);
    // Add click listeners to tab links to save tab
    document.querySelectorAll('a[href^="#"]').forEach(link => {
      link.addEventListener('click', function(e) {
        const tab = this.getAttribute('href').replace('#', '');
        showTab(tab);
      });
    });
  </script>
{% endblock %}
